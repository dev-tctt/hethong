<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üñ•Ô∏è Th√¥ng tin h·ªá th·ªëng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #e0f2fe;
      --bg-2: #f0f9ff;
      --card: #ffffff;
      --border: #bae6fd;
      --text: #0f172a;
      --muted: #334155;
      --primary: #0ea5e9;
      --primary-dark: #0284c7;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --neutral: #64748b;
    }
    body {
      font-family: system-ui, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg), var(--bg-2));
      color: var(--text);
      padding: 16px;
      margin: 0;
      display: block;
    }
    .wrap {
      width: 100%;
      max-width: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(2, 132, 199, .10);
      padding: 20px;
      box-sizing: border-box;
      min-height: calc(100vh - 32px);
    }
    h2 { margin: 0 0 10px; text-align: center; font-size: 26px; color: var(--primary-dark); }
    .grid { display: grid; grid-template-columns: 4fr 2fr 1.5fr 120px 120px; gap: 10px; }
    @media (max-width: 760px) { .grid { grid-template-columns: 1fr; } }
    input[type="url"], input[type="text"], input[type="search"], input[type="date"] {
      padding: 10px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--bg-2); color: var(--text); outline: none;
    }
    input[type="url"]:focus, input[type="text"]:focus, input[type="search"]:focus, input[type="date"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14,165,233,.2);
      background: #fff;
    }
    button { padding: 10px 12px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; }
    .add { background: var(--success); color: white; }
    .wipe { background: var(--neutral); color: white; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin: 14px 0 4px; }
    .export { background: var(--primary); color: white; }
    .template { background: #8b5cf6; color: white; }
    .delete-all {
      background: var(--danger); color: white; margin-left: auto;
      font-size: 28px; line-height: 1;
      width: 56px; height: 48px;
      display: inline-flex; align-items: center; justify-content: center;
      border-radius: 12px;
    }
    .searchbox { display:flex; gap:10px; align-items:center; background: var(--bg-2); padding:10px; border:1px solid var(--border); border-radius:12px; margin-top:10px;}
    .searchbox button { background:#e2e8f0; color:#0f172a; border:1px solid var(--border); }
    .searchbox label { font-weight:700; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; table-layout: fixed; }
    th, td { border: 1px solid var(--border); padding: 10px; text-align: left; vertical-align: top; }
    th { background: #f0f9ff; color: var(--muted); }
    tr:nth-child(even) { background: #f8fdff; }
    table th:nth-child(1), table td:nth-child(1) { text-align: center; }
    .actions { display: flex; gap: 8px; }
    .edit { background: var(--neutral); color: white; font-size: 16px; }
    .del { background: var(--danger); color: white; font-size: 16px; }
    a.link {
      color: var(--primary-dark);
      text-decoration: none;
      word-break: break-word;
      overflow-wrap: anywhere;
      white-space: normal;
      display:block;
    }
    #status { display: none; background: #fff7ed; color: #9a3412; border:1px solid #fed7aa; padding: 10px; border-radius: 10px; font-size: 13px; margin-top:10px; }
    label.file { display: inline-flex; align-items: center; gap: 8px; background: var(--warning); color: #111827; padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 700; }
    label.file input { display: none; }
    .actions button[title], #addBtn[title], .delete-all[title] { position: relative; }
    .actions button[title]:hover::after, #addBtn[title]:hover::after, .delete-all[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 110%; left: 50%; transform: translateX(-50%);
      background: #0f172a; color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 12px; white-space: nowrap; opacity: .9;
    }
    .meta { display:flex; justify-content: space-between; align-items:center; gap:10px; margin-top:10px; color: var(--muted); font-size:13px; }
    .toggle { display:inline-flex; align-items:center; gap:8px; background:#f1f5f9; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:13px; color:#334155; cursor:pointer; }
    .toggle input { accent-color: var(--primary); }
    #link {
      padding: 10px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--bg-2); color: var(--text); outline: none;
      min-height: 42px; line-height: 1.4; resize: vertical;
    }
    #link:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14,165,233,.2); background: #fff; }
    .delete-all { width: 42px; min-width: 42px; height: 42px; display: grid; place-items: center; padding: 0; font-size: 18px; }
    .topbar{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;margin-bottom:8px;}
    .topbar h2{grid-column:2;justify-self:center;text-align:center;}
    .lock{grid-column:3;justify-self:end;display:inline-flex;gap:8px;align-items:center;background:#f1f5f9;border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;color:#334155;}
    .lock .btn{height:28px;width:34px;padding:0;border-radius:999px}
    .lock .btn[disabled]{opacity:.5;cursor:not-allowed}
    .locked-actions .edit,.locked-actions .del{opacity:.35;pointer-events:none;}
    .row .lock{ margin-left: 8px; }
    .row .lock.unlocked { background: #dcfce7; border-color: #86efac; color: #065f46; box-shadow: 0 0 0 3px rgba(16,185,129,.18); }
    .row .lock{ position: static !important; display: inline-flex !important; gap: 8px; align-items: center; background: #f1f5f9; border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 13px; color: #334155; }
    .row .lock .btn{ height: 28px; width: 34px; padding: 0; border-radius: 999px; }
    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal{ background:#fff; padding:20px; border-radius:14px; min-width:320px; max-width:92vw; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .modal h3{ margin:0 0 10px; font-size:18px; color:#0f172a; }
    .modal .field{ display:flex; flex-direction:column; gap:6px; margin:8px 0; }
    .modal input[type="password"]{ width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; outline:none; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .btn-primary{ background:var(--primary); color:#fff; }
    /* Buttons visual tweaks */
    button.add,
    button.wipe { background: #ef4444; color: #fff; font-size: 22px; }
    button.wipe { background: #ef4444; color: #fff; font-size: 22px; }
    button.wipe:hover { background: #dc2626; }
    .delete-all {
      background: #fbbf24 !important;
      color: #ef4444 !important;
      font-size: 28px !important;
    }
    .delete-all:hover { background: #f59e0b !important; color: #b91c1c !important; }
    button.wipe { background: #fbbf24 !important; color: #ef4444 !important; font-size: 22px !important; }
    button.wipe:hover { background: #f59e0b !important; color: #b91c1c !important; }
    button.add { background: #22c55e !important; color: #fff !important; }
    button.add:hover { background: #16a34a !important; }
    button.add { background: #38bdf8 !important; color: #fff !important; }
    button.add:hover { background: #0ea5e9 !important; }
    button.wipe { background: #fbbf24 !important; color: #ef4444 !important; font-size: 22px !important; }
    button.wipe:hover { background: #f59e0b !important; color: #b91c1c !important; }
    .delete-all { background: #ef4444 !important; color: #fff !important; font-size: 28px !important; }
    delete-all:hover { background: #dc2626 !important; }
    button.wipe { background: #fbbf24 !important; color: #ef4444 !important; font-size: 22px !important; }
    button.wipe:hover { background: #f59e0b !important; color: #b91c1c !important; }
    .delete-all { background: #ef4444 !important; color: #fff !important; font-size: 28px !important; }
    .delete-all:hover { background: #dc2626 !important; }
    button.wipe[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 110%; left: 50%; transform: translateX(-50%);
      background: #000; color: #fff; padding: 4px 8px;
      border-radius: 6px; font-size: 12px; white-space: nowrap; opacity: .95;
      z-index: 1000;
    }
    button[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 110%; left: 50%; transform: translateX(-50%);
      background: #000; color: #fff; padding: 4px 8px;
      border-radius: 6px; font-size: 12px; white-space: nowrap; opacity: .95;
      z-index: 1000;
      animation: fadeInTooltip 120ms ease-out;
    }
    button[title] { position: relative; overflow: visible; }
    @keyframes fadeInTooltip {
      from { opacity: 0; transform: translate(-50%, -4px); }
      to   { opacity: .95; transform: translate(-50%, 0); }
    }
    table th { text-align: center !important; }
    table td:nth-child(3) { word-break: break-word; overflow-wrap: anywhere; white-space: pre-wrap; }
    table td:nth-child(4) { word-break: break-word; overflow-wrap: anywhere; white-space: pre-wrap; }
    #reverseToggle:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      color: #fff;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0.95;
      pointer-events: none;
      z-index: 1000;
    }
    table td:nth-child(2) { word-break: break-word; overflow-wrap: anywhere; white-space: pre-wrap; }
    td.actions { padding: 4px !important; vertical-align: middle !important; }
    td.actions { display: flex; justify-content: center; align-items: center; gap: 6px; }
    td.actions { padding: 4px !important; display: flex; justify-content: center; align-items: center; gap: 6px; vertical-align: middle !important; }
    td.actions {
      padding-top: 6px !important;
      padding-bottom: 4px !important;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 6px;
      vertical-align: top !important;
    }
    table td { line-height: 1.35; }
    td.actions { display: flex !important; justify-content: center !important; align-items: center !important; padding: 4px !important; gap: 6px !important; vertical-align: middle !important; }
    a.link { color: var(--primary-dark) !important; text-decoration: underline !important; }
    a.link:hover { color: var(--primary) !important; }
    tr.plain-row { background: #e6f6ff !important; }
    td.actions { background: #ecfdf5 !important; }
    th { background: #1fff8c !important; color: #ffffff !important; }
    table, th, td { border: 1px solid #16a34a !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h2 id="title">üñ•Ô∏è Th√¥ng tin h·ªá th·ªëng</h2>
    </div>

    <div class="grid">
      <textarea id="noidung" rows="2" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
      <input id="note" type="text" placeholder="Ghi ch√∫" />
      <input id="time" type="date" placeholder="dd/mm/yyyy" />
      <button id="addBtn" class="add" onclick="addItem()" title="Th√™m m·ªõi">‚ûï</button>
      <button class="wipe" onclick="resetForm()" title="X√≥a form">‚å´</button>
    </div>

    <div class="row">
      <button class="export" onclick="exportExcel()">Xu·∫•t Excel (.xlsx)</button>
      <label class="file">
        Nh·∫≠p Excel
        <input id="importXLSX" type="file" accept=".xlsx,.xls" onchange="importExcel(event)" />
      </label>
      <button class="template" onclick="downloadExcelTemplate()">T·∫£i file m·∫´u Excel</button>
      <button class="delete-all" onclick="clearAll()" title="X√≥a t·∫•t c·∫£">üí£</button>
      <span id="reverseToggle" data-tooltip="S·∫Øp x·∫øp" style="position:relative;display:inline-flex;align-items:center;justify-content:center;width:42px;min-width:42px;height:42px;background:#22c55e;color:#ffffff;border:1px solid #16a34a;border-radius:6px;font-size:18px;line-height:1;cursor:pointer;user-select:none;box-shadow:0 1px 0 rgba(0,0,0,.05);">‚¨Ü‚¨á</span>
      <div class="lock" id="lockBox">
        <button class="btn gray" id="unlockBtn" onclick="unlock()" title="M·ªü kh√≥a">üîê</button>
        <button class="btn gray" id="lockBtn" onclick="lock()" title="Kh√≥a">üîí</button>
      </div>
    </div>

    <div class="searchbox">
      <label for="search">üîé T√¨m ki·∫øm</label>
      <input id="search" type="search" placeholder="Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ l·ªçc theo N·ªôi dung/Ghi ch√∫/Th·ªùi gian..." oninput="onSearchInput(this.value)" />
    </div>

    <div id="status"></div>

    <table id="mainTable">
      <colgroup>
        <col style="width:70px" />
        <col style="width:auto" />
        <col style="width:26%" />
        <col style="width:150px" />
        <col style="width:120px" />
      </colgroup>
      <thead>
        <tr>
          <th>STT</th>
          <th>N·ªôi dung</th>
          <th>Ghi ch√∫</th>
          <th>Th·ªùi gian</th>
          <th>Ch·ª©c nƒÉng</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div id="storageInfo" style="margin-top:10px; font-size:13px; color:#334155;"></div>
    <div class="meta">
      <div id="countInfo">Hi·ªÉn th·ªã 0 m·ª•c</div>
      <div></div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <h3 id="pwTitle">Nh·∫≠p m·∫≠t kh·∫©u</h3>
      <div class="field">
        <label for="pwInput" id="pwLabel">M·∫≠t kh·∫©u</label>
        <input id="pwInput" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div class="field" id="confirmField" style="display:none;">
        <label for="pwConfirm">Nh·∫≠p l·∫°i m·∫≠t kh·∫©u</label>
        <input id="pwConfirm" type="password" autocomplete="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div class="actions">
        <button id="pwCancel">H·ªßy</button>
        <button id="pwOk" class="btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"
          onload="sheetReady(true)" onerror="sheetReady(false)"></script>

  <script>
  // ====== Utilities (textarea auto-resize) ======
  (function(){
    function autoResize(el){ if(!el) return; el.style.height='auto'; el.style.height=Math.min(el.scrollHeight, 260)+'px'; }
    const linkEl = document.getElementById('noidung');
    if (linkEl) {
      linkEl.addEventListener('input', e => autoResize(e.target));
      setTimeout(()=>autoResize(linkEl), 0);
    }
    const _resetForm = window.resetForm;
    window.resetForm = function(){ if(_resetForm) _resetForm(); const el=document.getElementById('noidung'); if(el) autoResize(el); };
    const _editRow = window.editRow;
    window.editRow = function(i){ if(_editRow) _editRow(i); const el=document.getElementById('noidung'); if(el) autoResize(el); };
  })();

  // ====== Password Modal helper ======
  const PasswordModal = (function(){
    const backdrop = document.getElementById('passwordBackdrop');
    const input = document.getElementById('pwInput');
    const confirmField = document.getElementById('confirmField');
    const confirmInput = document.getElementById('pwConfirm');
    const btnOk = document.getElementById('pwOk');
    const btnCancel = document.getElementById('pwCancel');
    const title = document.getElementById('pwTitle');
    const label = document.getElementById('pwLabel');

    let resolver = null;
    let withConfirm = false;

    function open(opts={}){
      withConfirm = !!opts.withConfirm;
      title.textContent = opts.title || 'Nh·∫≠p m·∫≠t kh·∫©u';
      label.textContent = opts.label || 'M·∫≠t kh·∫©u';
      input.value = '';
      confirmInput.value = '';
      confirmField.style.display = withConfirm ? '' : 'none';
      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden','false');
      setTimeout(()=>input.focus(), 0);
      return new Promise((resolve)=>{ resolver = resolve; });
    }
    function close(result){
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden','true');
      const out = result===true ? (withConfirm ? {pass: input.value, confirm: confirmInput.value} : {pass: input.value}) : null;
      if(resolver){ resolver(out); resolver = null; }
    }

    btnOk.addEventListener('click', ()=> close(true));
    btnCancel.addEventListener('click', ()=> close(false));
    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) close(false); });
    backdrop.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){ e.preventDefault(); close(false); }
      if(e.key === 'Enter'){ e.preventDefault(); btnOk.click(); }
    });
    ['pwInput','pwConfirm','pwCancel','pwOk'].forEach(id=>{
      document.getElementById(id).addEventListener('keydown', (e)=>{
        if(e.key === 'Tab'){ e.stopPropagation(); }
      });
    });

    return { open };
  })();

  // ====== Lock state (admin) ======
  const PASS_KEY = 'links_admin_pass_v1';
  const DEFAULT_ADMIN_PASS = 'coichungchocan'; // m·∫∑c ƒë·ªãnh
  let ADMIN_PASS = localStorage.getItem(PASS_KEY) || '';
  let UNLOCKED = sessionStorage.getItem('links_unlocked') === '1';

  function refreshLockUI(){
    const table=document.getElementById('mainTable');
    if(table){ if(!UNLOCKED) table.classList.add('locked-actions'); else table.classList.remove('locked-actions'); }
    const unlockBtn = document.getElementById('unlockBtn');
    const lockBtn = document.getElementById('lockBtn');
    if(unlockBtn) unlockBtn.disabled = UNLOCKED;
    if(lockBtn) lockBtn.disabled = !UNLOCKED;
    const box = document.getElementById('lockBox');
    if(box){ if(UNLOCKED) box.classList.add('unlocked'); else box.classList.remove('unlocked'); }
  }

  async function unlock(){
    const need = ADMIN_PASS || DEFAULT_ADMIN_PASS;
    const res = await PasswordModal.open({ title: 'M·ªü kh√≥a', label: 'Nh·∫≠p m·∫≠t kh·∫©u' });
    if(!res) return;
    if(res.pass === need){
      UNLOCKED = true;
      sessionStorage.setItem('links_unlocked','1');
      refreshLockUI();
      alert('ƒê√£ m·ªü kh√≥a.');
    } else {
      alert('Sai m·∫≠t kh·∫©u.');
    }
  }

  function lock(){
    UNLOCKED = false;
    sessionStorage.removeItem('links_unlocked');
    refreshLockUI();
  }

  async function setAdminPass(){
    if(!UNLOCKED){ alert('Vui l√≤ng m·ªü kh√≥a tr∆∞·ªõc khi ƒë·ªïi m·∫≠t kh·∫©u.'); return; }
    const need = ADMIN_PASS || DEFAULT_ADMIN_PASS;
    const cur = await PasswordModal.open({ title:'X√°c th·ª±c', label:'M·∫≠t kh·∫©u hi·ªán t·∫°i' });
    if(!cur) return;
    if(cur.pass !== need){ alert('Sai m·∫≠t kh·∫©u hi·ªán t·∫°i.'); return; }
    const next = await PasswordModal.open({ title:'ƒê·ªïi m·∫≠t kh·∫©u', label:'M·∫≠t kh·∫©u m·ªõi', withConfirm:true });
    if(!next) return;
    if(!next.pass.trim()){ alert('M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.'); return; }
    if(next.pass !== next.confirm){ alert('Hai l·∫ßn nh·∫≠p kh√¥ng kh·ªõp!'); return; }
    ADMIN_PASS = next.pass;
    localStorage.setItem(PASS_KEY, ADMIN_PASS);
    alert('ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');
  }

  function guard(){
    if(!UNLOCKED){ alert('T√≠nh nƒÉng n√†y ƒëang kh√≥a. B·∫•m üîê v√† nh·∫≠p m·∫≠t kh·∫©u.'); return false; }
    return true;
  }

  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.altKey && (e.key==='p' || e.key==='P')){ e.preventDefault(); setAdminPass(); }
  });

  // ====== IndexedDB (ch·ªâ l∆∞u d·ªØ li·ªáu ch√≠nh) ======
  const DB_NAME = 'system_info_db_v1';
  const DB_STORE = 'kv';
  const DATA_KEY = 'system_info_data_v1'; // gi·ªØ t√™n key c≈© cho t∆∞∆°ng th√≠ch
  let dbPromise = null;
  let dataLoaded = false;
  let rows = [];

  function idbOpen(){
    if (dbPromise) return dbPromise;
    dbPromise = new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = (e)=>{
        const db = req.result;
        if (!db.objectStoreNames.contains(DB_STORE)) {
          db.createObjectStore(DB_STORE);
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
    return dbPromise;
  }
  async function idbGet(key){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(DB_STORE, 'readonly');
      const store = tx.objectStore(DB_STORE);
      const getReq = store.get(key);
      getReq.onsuccess = ()=> resolve(getReq.result);
      getReq.onerror = ()=> reject(getReq.error);
    });
  }
  async function idbSet(key, value){
    const db = await idbOpen();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(DB_STORE, 'readwrite');
      const store = tx.objectStore(DB_STORE);
      const putReq = store.put(value, key);
      putReq.onsuccess = ()=> resolve(true);
      putReq.onerror = ()=> reject(putReq.error);
    });
  }

  function cleanRows(list){
    if (!Array.isArray(list)) return [];
    return list.map(r => {
      if (r && typeof r === 'object') {
        if (r.link && !r.noidung) r.noidung = r.link;
        if (r.noidung && typeof r.noidung !== 'string') {
          try {
            if (typeof r.noidung.value === 'string' && r.noidung.value) r.noidung = String(r.noidung.value);
            else if (typeof r.noidung.textContent === 'string') r.noidung = String(r.noidung.textContent);
            else r.noidung = String(r.noidung);
          } catch(e){ r.noidung = String(r.noidung); }
        }
        if (r.note && typeof r.note !== 'string') r.note = String(r.note);
        if (r.time && typeof r.time !== 'string') r.time = String(r.time);
      }
      return r;
    });
  }

  // C√°c flag nh·ªè v·∫´n d√πng localStorage
  const REVERSE_KEY = 'links_reverse_order_v1';
  let REVERSE = localStorage.getItem(REVERSE_KEY) === '1';

  // ====== Helpers kh√°c ======
  function setReverseVisual(){
    const rev = document.getElementById('reverseToggle');
    if(!rev) return;
    rev.style.opacity = REVERSE ? '1' : '0.85';
    rev.style.transform = REVERSE ? 'scale(1.0)' : 'scale(0.98)';
    rev.setAttribute('aria-pressed', REVERSE ? 'true' : 'false');
  }
  let q = '';
  let fNoi = '', fNote = '';

  async function save(){
    try {
      rows = cleanRows(rows);
      await idbSet(DATA_KEY, JSON.stringify(rows));
    } catch(e){
      console.error('L∆∞u IndexedDB l·ªói:', e);
      alert('Kh√¥ng l∆∞u ƒë∆∞·ª£c v√†o IndexedDB. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.');
    }
  }
  function normalize(v){ return (v||'').toString().toLowerCase(); }
  function toDMY(ymd){
    if(!ymd) return '';
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd.trim());
    if(!m) return ymd;
    return `${m[3]}/${m[2]}/${m[1]}`;
  }
  function toYMD(dmy){
    if(!dmy) return '';
    const m = /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/.exec(dmy.trim());
    if(!m) return '';
    const d = m[1].padStart(2,'0'), mo = m[2].padStart(2,'0'), y = m[3];
    return `${y}-${mo}-${d}`;
  }
  function normalizeTimeInput(value){
    if(!value) return '';
    if(/^\d{4}-\d{2}-\d{2}$/.test(value)) return toDMY(value);
    if(/^\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}$/.test(value)) {
      const m = /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/.exec(value);
      return `${m[1].padStart(2,'0')}/${m[2].padStart(2,'0')}/${m[3]}`;
    }
    return value.trim();
  }
  function excelDateToDMY(serial){
    if (!serial || isNaN(serial)) return '';
    const utc_days = Math.floor(serial - 25569);
    const utc_value = utc_days * 86400;
    const date_info = new Date(utc_value * 1000);
    const d = String(date_info.getUTCDate()).padStart(2,'0');
    const m = String(date_info.getUTCMonth()+1).padStart(2,'0');
    const y = date_info.getUTCFullYear();
    return `${d}/${m}/${y}`;
  }
  function filteredRows() {
    let data = rows;
    if (q) {
      const k = normalize(q);
      data = data.filter(r =>
        normalize(r.noidung).includes(k) ||
        normalize(r.note).includes(k) ||
        normalize(r.time).includes(k)
      );
    }
    if (typeof fNoi !== 'undefined' && fNoi) {
      const k = normalize(fNoi);
      data = data.filter(r => normalize(r.noidung).includes(k));
    }
    if (typeof fNote !== 'undefined' && fNote) {
      const k = normalize(fNote);
      data = data.filter(r => normalize(r.note).includes(k));
    }
    return data;
  }
  function escapeHTML(s){
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }
  function escapeAttr(s){
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }
  function hasURL(s){
    if (!s || typeof s !== 'string') return false;
    const re = /(\b(https?:\/\/|www\.)[^\s<>()]+[^\s.,;:!?)<>\n\r])/i;
    return re.test(s);
  }
  function linkify(text){
    if (!text) return '';
    const re = /(\b(https?:\/\/|www\.)[^\s<>()]+[^\s.,;:!?)<>\n\r])/gi;
    let out = '';
    let last = 0;
    let m;
    while ((m = re.exec(text)) !== null) {
      const start = m.index;
      const end = re.lastIndex;
      const raw = m[0];
      out += escapeHTML(text.slice(last, start));
      let href = raw;
      if (/^www\./i.test(href)) href = 'https://' + href;
      out += `<a class="link" href="${escapeAttr(href)}" target="_blank" rel="noopener noreferrer nofollow">${escapeHTML(raw)}</a>`;
      last = end;
    }
    out += escapeHTML(text.slice(last));
    return out;
  }

  function render() {
    if (!dataLoaded) return; // ƒë·ª£i d·ªØ li·ªáu t·ª´ IndexedDB
    rows = cleanRows(rows);
    const tb = document.getElementById('tbody');
    tb.innerHTML = '';
    let fr = filteredRows();
    if (REVERSE) fr = [...fr].reverse();
    fr.forEach((r, i) => {
      const tr = document.createElement('tr');
      try { if (!hasURL(r.noidung)) { tr.classList.add('plain-row'); } } catch(e) {}
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${ r.noidung ? linkify(r.noidung) : "" }</td>
        <td>${r.note || ''}</td>
        <td>${r.time || ''}</td>
        <td class="actions">
          <button class="edit" onclick="editRow(${rows.indexOf(r)})" title="S·ª≠a">‚úèÔ∏è</button>
          <button class="del" onclick="delRow(${rows.indexOf(r)})" title="X√≥a">üóëÔ∏è</button>
        </td>`;
      tb.appendChild(tr);
    });
    document.getElementById('countInfo').innerText = `Hi·ªÉn th·ªã ${fr.length} / ${rows.length} m·ª•c`;
    refreshLockUI();
    setReverseVisual();
    checkStorageUsage();
  }

  async function addItem(){
    const noidung = document.getElementById('noidung').value.trim();
    const note = document.getElementById('note').value.trim();
    const time = normalizeTimeInput(document.getElementById('time').value.trim());
    if (!noidung) return alert('Vui l√≤ng nh·∫≠p N·ªôi dung');
    if (editing !== -1 && !guard()) return;
    if (editing === -1) rows.unshift({ noidung, note, time });
    else {
      rows[editing] = { noidung, note, time };
      editing = -1;
      const btn = document.getElementById('addBtn');
      btn.innerText = '‚ûï';
      btn.title = 'Th√™m m·ªõi';
    }
    await save(); render(); resetForm();
  }

  function editRow(i){
    if(!guard()) return;
    document.getElementById('noidung').value = rows[i].noidung || '';
    document.getElementById('note').value = rows[i].note || '';
    document.getElementById('time').value = toYMD(rows[i].time || '') || '';
    editing = i;
    const btn = document.getElementById('addBtn');
    btn.innerText = 'üîÑ';
    btn.title = 'C·∫≠p nh·∫≠t';
    document.getElementById('note').focus();
  }

  async function delRow(i){
    if(!guard()) return;
    if (!confirm('X√≥a m·ª•c n√†y?')) return;
    rows.splice(i,1);
    await save(); render();
    if (editing === i) resetForm();
  }

  function resetForm() {
    document.getElementById('noidung').value = '';
    document.getElementById('note').value = '';
    document.getElementById('time').value = '';
    editing = -1;
    const btn = document.getElementById('addBtn');
    btn.innerText = '‚ûï';
    btn.title = 'Th√™m m·ªõi';
  }

  async function clearAll(){
    if(!guard()) return;
    if (!confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu?')) return;
    rows = [];
    await save(); render(); resetForm();
  }

  function onSearchInput(val) { q = val || ''; render(); }
  function onColFilterChange(){
    const n = document.getElementById('fNoi'); fNoi = n ? n.value : '';
    const g = document.getElementById('fNote'); fNote = g ? g.value : '';
    render();
  }
  function resetFilters(){
    const ids = ['search','fNoi','fNote'];
    ids.forEach(id=>{ const el = document.getElementById(id); if(el) el.value=''; });
    q = fNoi = fNote = '';
    render();
  }

  function sheetReady(ok) {
    const st = document.getElementById('status');
    if (!ok || typeof XLSX === 'undefined') {
      st.style.display = 'block';
      st.innerHTML = '<b>L∆∞u √Ω:</b> Kh√¥ng t·∫£i ƒë∆∞·ª£c th∆∞ vi·ªán Excel qua CDN. Ki·ªÉm tra Internet ho·∫∑c th·ª≠ l·∫°i sau.';
    } else {
      st.style.display = 'none';
    }
  }

  function exportExcel() {
    if (typeof XLSX === 'undefined') return alert('Ch∆∞a s·∫µn s√†ng th∆∞ vi·ªán Excel (CDN).');
    const wb = XLSX.utils.book_new();
    const src = filteredRows();
    const aoa = [['N·ªôi dung','Ghi ch√∫','Th·ªùi gian'], ...src.map(r => [r.noidung || '', r.note || '', r.time || ''])];
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    XLSX.utils.book_append_sheet(wb, ws, 'Links');
    XLSX.writeFile(wb, 'file_mau.xlsx');
  }

  function downloadExcelTemplate() {
    if (typeof XLSX === 'undefined') return alert('Ch∆∞a s·∫µn s√†ng th∆∞ vi·ªán Excel (CDN).');
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([['N·ªôi dung','Ghi ch√∫','Th·ªùi gian'], ['https://vi-du.com', 'V√≠ d·ª• ghi ch√∫', '31/08/2025 09:00']]);
    XLSX.utils.book_append_sheet(wb, ws, 'Template');
    XLSX.writeFile(wb, 'file_mau_template.xlsx');
  }

  function importExcel(ev) {
    if (typeof XLSX === 'undefined') { ev.target.value=''; return alert('Ch∆∞a s·∫µn s√†ng th∆∞ vi·ªán Excel (CDN).'); }
    const f = ev.target.files[0]; if (!f) return;
    const reader = new FileReader();
    reader.onload = async e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type:'array' });
      const sh = wb.SheetNames[0];
      const ws = wb.Sheets[sh];
      const arr = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
      if (!arr || !arr.length) return alert('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu trong file.');

      let start = 0;
      let h = (arr[0] || []).map(v => (v==null?'':String(v)).trim().toLowerCase());
      let idxNoi = 0, idxNote = 1, idxTime = 2;
      const isHeader = (
        h.some(s => s.includes('n·ªôi') || s.includes('noi') || s.includes('content') || s.includes('link')) &&
        h.some(s => s.includes('ghi') || s.includes('note'))
      );
      if (isHeader) {
        start = 1;
        idxNoi  = h.findIndex(s => s.includes('n·ªôi') || s.includes('noi') || s.includes('content') || s.includes('link'));
        idxNote = h.findIndex(s => s.includes('ghi') || s.includes('note'));
        idxTime = h.findIndex(s => s.includes('th·ªùi') || s.includes('thoi') || s.includes('time') || s.includes('ng√†y') || s.includes('ngay') || s.includes('date'));
        if (idxTime < 0) idxTime = 2;
        if (idxNoi < 0) idxNoi = 0;
        if (idxNote < 0) idxNote = 1;
      }

      const staged = [];
      for (let i = start; i < arr.length; i++) {
        const row = arr[i]; if (!row) continue;
        function cellToString(v){
          if (v == null) return '';
          if (typeof v === 'string') return v.trim();
          if (typeof v === 'number') return String(v);
          if (typeof v === 'boolean') return v ? 'true' : 'false';
          try { return String(v); } catch(e){ return ''; }
        }
        const cellNoi  = row[idxNoi];
        const cellNote = row[idxNote];
        const cellTime = row[idxTime];
        let noidung = cellToString(cellNoi);
        let note    = cellToString(cellNote);
        let time    = '';
        if (typeof cellTime === 'number') time = excelDateToDMY(cellTime);
        else time = normalizeTimeInput(cellToString(cellTime));
        if (noidung) { staged.push({ noidung, note, time }); }
      }
      if (staged.length) {
        for (let i = staged.length - 1; i >= 0; i--) {
          rows.unshift(staged[i]);
        }
        await save(); render();
      } else {
        alert('Kh√¥ng c√≥ h√†ng h·ª£p l·ªá ƒë·ªÉ nh·∫≠p.');
      }
      ev.target.value='';
    };
    reader.readAsArrayBuffer(f);
  }

  // ==== Reverse toggle binding ====
  (function(){
    function setReverseVisualHard(){
      var rev = document.getElementById('reverseToggle');
      if(!rev) return;
      var on = REVERSE;
      rev.style.cursor = 'pointer';
      rev.style.opacity = on ? '1' : '0.85';
      rev.style.transform = on ? 'scale(1.0)' : 'scale(0.98)';
      rev.style.filter = on ? 'brightness(1)' : 'brightness(0.95)';
      rev.setAttribute('aria-pressed', on ? 'true' : 'false');
    }
    function bindReverse(){
      var rev = document.getElementById('reverseToggle');
      if(!rev) return;
      if (!rev._boundReverse) {
        rev.addEventListener('click', function(){
          REVERSE = !REVERSE;
          try { localStorage.setItem('links_reverse_order_v1', REVERSE ? '1' : '0'); } catch(e){}
          render();
          setReverseVisualHard();
        });
        rev._boundReverse = true;
      }
      setReverseVisualHard();
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', bindReverse);
    } else { bindReverse(); }
    setTimeout(bindReverse, 500);
  })();

  // ====== Hi·ªÉn th·ªã ∆∞·ªõc t√≠nh dung l∆∞·ª£ng localStorage (ch·ªâ tham kh·∫£o) ======
  
async function calcIndexedDBTotal() {
  let total = 0;
  try {
    const db = await idbOpen();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, "readonly");
      const store = tx.objectStore(DB_STORE);
      const req = store.openCursor();
      req.onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
          try {
            total += JSON.stringify(cursor.value).length * 2;
          } catch(err) {}
          cursor.continue();
        } else {
          resolve(total);
        }
      };
      req.onerror = () => reject(req.error);
    });
  } catch (e) {
    console.warn("Kh√¥ng t√≠nh ƒë∆∞·ª£c t·ªïng IndexedDB:", e);
    return 0;
  }
}


async function checkStorageUsage() {
  // --- localStorage ---
  let usedLS = 0;
  for (let key in localStorage) {
    if (localStorage.hasOwnProperty(key)) {
      usedLS += ((localStorage[key].length + key.length) * 2);
    }
  }
  let maxLS = 5 * 1024 * 1024; // 5MB m·∫∑c ƒë·ªãnh
  let freeLS = maxLS - usedLS;

  function formatBytes(b) {
    if (b < 1024) return b + " B";
    if (b < 1024*1024) return (b/1024).toFixed(1) + " KB";
    return (b/1024/1024).toFixed(2) + " MB";
  }

  // --- IndexedDB (t·ªïng) ---
  let usedIDB = await calcIndexedDBTotal();

  const el = document.getElementById("storageInfo");
  if (el) {
    el.innerHTML =
      "LocalStorage: " + formatBytes(usedLS) + " / " + formatBytes(maxLS) +
      " (C√≤n: " + formatBytes(freeLS) + ")<br>" +
      "IndexedDB (t·ªïng): " + formatBytes(usedIDB) + " (∆∞·ªõc t√≠nh)";
  }
}


  // ====== Kh·ªüi t·∫°o: n·∫°p d·ªØ li·ªáu t·ª´ IndexedDB v√† render ======
  let editing = -1;
  document.addEventListener('DOMContentLoaded', async ()=>{
    try {
      const raw = await idbGet(DATA_KEY);
      if (raw) {
        try { rows = JSON.parse(raw) || []; }
        catch(e){ console.warn('Kh√¥ng parse ƒë∆∞·ª£c JSON; reset h√†ng:', e); rows = []; }
      } else {
        // N·∫øu tr∆∞·ªõc ƒë√¢y c√≥ d·ªØ li·ªáu trong localStorage, migrate 1 l·∫ßn
        try {
          const legacy = localStorage.getItem(DATA_KEY);
          if (legacy) {
            rows = JSON.parse(legacy) || [];
            await idbSet(DATA_KEY, legacy);
            // KH√îNG x√≥a localStorage ƒë·ªÉ tr√°nh m·∫•t khi user quay l·∫°i b·∫£n c≈©; c√≥ th·ªÉ t·ª± x√≥a sau
          } else {
            rows = [];
          }
        } catch(e){ rows = []; }
      }
    } catch(e){
      console.error('L·ªói ƒë·ªçc IndexedDB:', e);
      rows = [];
    } finally {
      rows = cleanRows(rows);
      dataLoaded = true;
      render();
      document.getElementById('title')?.addEventListener('dblclick', ()=> setAdminPass() );
      refreshLockUI();
      document.getElementById('passwordBackdrop').tabIndex = -1;
      checkStorageUsage();
    }
  });
  </script>
</body>
</html>
